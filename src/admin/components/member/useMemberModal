import { useState, useEffect } from "react";
import { getDepartment, getJobPosition } from "../../api/MasterDataApi";
import { getMemberById, createMember, updateMember } from "../../api/MemberApi";
import { MasterData, Member } from "../../type";

// Custom Hook for handling member modal logic
export function useMemberModal(memberId?: number) {
  const [department, setDepartment] = useState<MasterData[]>([]);
  const [jobPosition, setJobPosition] = useState<MasterData[]>([]);
  const [member, setMember] = useState<Member | null>(null);
  const [errors, setErrors] = useState({
    loginId: "",
    password: "",
    phone: "",
    email: "",
  });
  const [showPassword, setShowPassword] = useState(false);
  const [isDuplicate, setIsDuplicate] = useState(false);
  const [idCheckTimer, setIdCheckTimer] = useState<NodeJS.Timeout | null>(null);

  // 부서 및 직급, 회원 정보 로딩
  useEffect(() => {
    async function fetchData() {
      try {
        const dep = await getDepartment();
        const pos = await getJobPosition();
        setDepartment(dep);
        setJobPosition(pos);

        if (memberId) {
          const memberData = await getMemberById(memberId);
          setMember(memberData);
        }
      } catch (error) {
        console.log("데이터를 불러오는 중 오류 발생", error);
      }
    }
    fetchData();
  }, [memberId]);

  // 필드 값 업데이트
  const handleChange = <K extends keyof Member>(field: K, value: Member[K]) => {
    if (member) {
      setMember((prev) => ({ ...prev, [field]: value }));
    }
  };

  // 유효성 검사
  const validateField = (field: string, value: string) => {
    let errorMsg = "";
    switch (field) {
      case "loginId":
        if (!/^[A-Za-z0-9]{4,20}$/.test(value)) errorMsg = "영문 또는 숫자 4~20자로 입력하세요.";
        break;
      case "password":
        if (!/^[^\sㄱ-ㅎ가-힣]{8,20}$/.test(value)) errorMsg = "한글 제외 8~20자로 입력하세요.";
        break;
      case "phone":
        if (!value.includes("-")) errorMsg = "하이픈(-)을 포함해주세요.";
        break;
      case "email":
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) errorMsg = "올바른 이메일 형식이 아닙니다.";
        break;
      default:
        break;
    }
    setErrors((prev) => ({ ...prev, [field]: errorMsg }));
  };

  // 등록 또는 수정 처리
  const handleSubmit = async () => {
    if (!member) return;

    // 각 필드 유효성 검사
    validateField("loginId", member.loginId);
    validateField("password", member.password);
    validateField("phone", member.phone);
    validateField("email", member.email);

    // 하나라도 에러가 있으면 제출하지 않음
    if (Object.values(errors).some((e) => e !== "")) return;

    try {
      let response;
      if (memberId) {
        response = await updateMember(memberId, member); // 수정
        console.log("회원 수정 성공:", response.data);
      } else {
        response = await createMember(member); // 등록
        console.log("회원 등록 성공:", response.data);
      }
      return response;
    } catch (error) {
      console.error("회원 처리 중 오류 발생:", error);
    }
  };

  return {
    department,
    jobPosition,
    member,
    errors,
    showPassword,
    setShowPassword,
    handleChange,
    validateField,
    handleSubmit,
    isDuplicate,
    setIsDuplicate,
    idCheckTimer,
    setIdCheckTimer,
  };
}
